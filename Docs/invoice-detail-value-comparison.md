# ๐ ููุงุฑูุฉ ุจูู ุงูููุฏ ุงููุฏูู ูุงูุฌุฏูุฏ ูุญุณุงุจ detail_value

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู ุญุณุงุจ `detail_value` ูู ุทุฑููุฉ ุจุณูุทุฉ ุฅูู ูุธุงู ูุชูุฏู ูุฏุนู ุงูุชูุฒูุน ุงููุณุจู ูุงูุถุฑุงุฆุจ ุนูู ูุณุชููุงุช ูุชุนุฏุฏุฉ.

---

## ๐ด ุงูููุฏ ุงููุฏูู (ุงูุทุฑููุฉ ุงูุจุณูุทุฉ)

### ุงูุทุฑููุฉ ุงููุฏููุฉ ูุญุณุงุจ detail_value

```php
// ุงูููุฏ ุงููุฏูู - ุญุณุงุจ ุจุณูุท ูุจุงุดุฑ
$detail_value = ($item_price * $quantity) - $item_discount;
```

**ูู JavaScript (Frontend):**
```javascript
// ุญุณุงุจ sub_value ูู ุงููุงุฌูุฉ
const subValue = (quantity * price) - discount;
item.sub_value = Math.max(0, subValue);
```

### ุฎุตุงุฆุต ุงูููุฏ ุงููุฏูู:

1. **ุญุณุงุจ ูุจุงุดุฑ ูุจุณูุท:**
   - `detail_value = (ุงูุณุนุฑ ร ุงููููุฉ) - ุฎุตู ุงูุตูู`
   - ูุง ููุฌุฏ ุชูุฒูุน ูุณุจู ููุฎุตููุงุช ุนูู ูุณุชูู ุงููุงุชูุฑุฉ
   - ูุง ููุฌุฏ ุฏุนู ููุถุฑุงุฆุจ (VAT ุฃู Withholding Tax)
   - ูุง ููุฌุฏ ุฏุนู ููุฅุถุงูุงุช (Additional Charges)

2. **ุงููุดุงูู:**
   - โ ูุง ูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุฎุตู ุงููุงุชูุฑุฉ (`fat_disc`)
   - โ ูุง ูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุฅุถุงูุฉ ุงููุงุชูุฑุฉ (`fat_plus`)
   - โ ูุง ูุฏุนู ุงูุถุฑุงุฆุจ ุนูู ูุณุชูู ุงูุตูู ุฃู ุงููุงุชูุฑุฉ
   - โ ูุง ููุฌุฏ ุชูุฒูุน ูุณุจู ููุฎุตููุงุช ูุงูุฅุถุงูุงุช
   - โ ูุง ููุฌุฏ ุชุญูู ูู ุฏูุฉ ุงูุญุณุงุจุงุช
   - โ ูุฏ ูุคุฏู ุฅูู ุฃุฎุทุงุก ูู ุญุณุงุจ `average_cost`

3. **ูุซุงู ุนูู ุงููุดููุฉ:**
   ```
   ูุงุชูุฑุฉ ุชุญุชูู ุนูู:
   - ุตูู 1: ุณุนุฑ 100ุ ูููุฉ 2ุ ุฎุตู ุตูู 10
   - ุตูู 2: ุณุนุฑ 200ุ ูููุฉ 1ุ ุฎุตู ุตูู 20
   - ุฎุตู ูุงุชูุฑุฉ: 50
   
   ุงูููุฏ ุงููุฏูู:
   - ุตูู 1: detail_value = (100 ร 2) - 10 = 190
   - ุตูู 2: detail_value = (200 ร 1) - 20 = 180
   - ุงููุฌููุน: 370 (ููู ุฎุตู ุงููุงุชูุฑุฉ 50 ูู ููุทุจู!)
   
   ุงููุชูุฌุฉ: ุญุณุงุจ ุฎุงุทุฆ ูู average_cost
   ```

---

## ๐ข ุงูููุฏ ุงูุฌุฏูุฏ (ุงููุธุงู ุงููุชูุฏู)

### ุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ - DetailValueCalculator Service

```php
// ุงูููุฏ ุงูุฌุฏูุฏ - ุงุณุชุฎุฏุงู DetailValueCalculator
$calculator = new DetailValueCalculator();
$calculation = $calculator->calculate($itemData, $invoiceData, $invoiceSubtotal);
$detail_value = $calculation['detail_value'];
```

### ุฎุตุงุฆุต ุงูููุฏ ุงูุฌุฏูุฏ:

#### 1. **ุฏุนู ูุณุชููุงุช ูุชุนุฏุฏุฉ (Levels)**

```php
// ุฅุนุฏุงุฏุงุช ุงููุณุชููุงุช
$discountLevel = 'invoice_level' | 'item_level' | 'both' | 'disabled';
$additionalLevel = 'invoice_level' | 'item_level' | 'both' | 'disabled';
$vatLevel = 'invoice_level' | 'item_level' | 'both' | 'disabled';
$withholdingTaxLevel = 'invoice_level' | 'item_level' | 'both' | 'disabled';
```

#### 2. **ุญุณุงุจ ูุชุนุฏุฏ ุงููุฑุงุญู (8 ุฎุทูุงุช)**

```php
// ุงูุฎุทูุฉ 1: ุญุณุงุจ ุงูุฎุตู ูุงูุฅุถุงูุฉ ุนูู ูุณุชูู ุงูุตูู
$itemDiscount = ($discountLevel === 'item_level' || $discountLevel === 'both') 
    ? $itemData['item_discount'] 
    : 0;
$itemAdditional = ($additionalLevel === 'item_level' || $additionalLevel === 'both') 
    ? $itemData['additional'] 
    : 0;

// ุงูุฎุทูุฉ 2: ุงููููุฉ ุงูุฃุณุงุณูุฉ ูุจู ุงูุถุฑุงุฆุจ
$itemValueBeforeTaxes = ($itemPrice * $quantity) - $itemDiscount + $itemAdditional;

// ุงูุฎุทูุฉ 3: ุญุณุงุจ ุงูุถุฑุงุฆุจ ุนูู ูุณุชูู ุงูุตูู
$itemLevelVat = ($vatLevel === 'item_level' || $vatLevel === 'both')
    ? calculateItemLevelVat($itemValueBeforeTaxes, $itemData)
    : 0;
$itemLevelWithholdingTax = ($withholdingTaxLevel === 'item_level' || $withholdingTaxLevel === 'both')
    ? calculateItemLevelWithholdingTax($itemValueBeforeTaxes, $itemData)
    : 0;

// ุงูุฎุทูุฉ 4: ุงููุฌููุน ุงููุฑุนู ููุตูู (ุฃุณุงุณ ุงูุชูุฒูุน)
$itemSubtotal = $itemValueBeforeTaxes + $itemLevelVat - $itemLevelWithholdingTax;

// ุงูุฎุทูุฉ 5: ุชูุฒูุน ุฎุตู ูุฅุถุงูุฉ ุงููุงุชูุฑุฉ ูุณุจูุงู
$distributedDiscount = ($discountLevel === 'invoice_level' || $discountLevel === 'both')
    ? $fat_disc * ($itemSubtotal / $invoiceSubtotal)
    : 0;
$distributedAdditional = ($additionalLevel === 'invoice_level' || $additionalLevel === 'both')
    ? $fat_plus * ($itemSubtotal / $invoiceSubtotal)
    : 0;

// ุงูุฎุทูุฉ 6: ุงูุตุงูู ุจุนุฏ ุงูุชูุฒูุน
$netAfterAdjustments = $itemSubtotal - $distributedDiscount + $distributedAdditional;

// ุงูุฎุทูุฉ 7: ุชูุฒูุน ุถุฑุงุฆุจ ุงููุงุชูุฑุฉ ูุณุจูุงู
$invoiceLevelVat = ($vatLevel === 'invoice_level' || $vatLevel === 'both')
    ? $vat_value * ($netAfterAdjustments / $invoiceSubtotal)
    : 0;
$invoiceLevelWithholdingTax = ($withholdingTaxLevel === 'invoice_level' || $withholdingTaxLevel === 'both')
    ? $withholding_tax_value * ($netAfterAdjustments / $invoiceSubtotal)
    : 0;

// ุงูุฎุทูุฉ 8: ุงููููุฉ ุงูููุงุฆูุฉ
$detailValue = $netAfterAdjustments + $invoiceLevelVat - $invoiceLevelWithholdingTax;
$detailValue = max(0, round($detailValue, 2));
```

#### 3. **ูุธุงู ุงูุชุญูู (DetailValueValidator)**

```php
// ุงูุชุญูู ูู:
// 1. ุนุฏู ูุฌูุฏ ููู ุณุงูุจุฉ
// 2. ุฏูุฉ ุงูุญุณุงุจุงุช (ูุงูุด ุฎุทุฃ 0.01)
// 3. ุชุทุงุจู ุฅุฌูุงูู ุงูุฃุตูุงู ูุน ุฅุฌูุงูู ุงููุงุชูุฑุฉ
// 4. ุตุญุฉ ุงููุณุชููุงุช (item_level vs invoice_level)
```

---

## ๐ ููุงุฑูุฉ ุชูุตูููุฉ

| ุงูููุฒุฉ | ุงูููุฏ ุงููุฏูู โ | ุงูููุฏ ุงูุฌุฏูุฏ โ |
|--------|----------------|----------------|
| **ุญุณุงุจ detail_value** | `(price ร qty) - discount` | ุญุณุงุจ ูุชุนุฏุฏ ุงููุฑุงุญู (8 ุฎุทูุงุช) |
| **ุฏุนู ุฎุตู ุงููุงุชูุฑุฉ** | โ ูุง | โ ูุนู (ุชูุฒูุน ูุณุจู) |
| **ุฏุนู ุฅุถุงูุฉ ุงููุงุชูุฑุฉ** | โ ูุง | โ ูุนู (ุชูุฒูุน ูุณุจู) |
| **ุฏุนู VAT** | โ ูุง | โ ูุนู (item/invoice/both) |
| **ุฏุนู Withholding Tax** | โ ูุง | โ ูุนู (item/invoice/both) |
| **ุงูุชูุฒูุน ุงููุณุจู** | โ ูุง | โ ูุนู |
| **ุงูุชุญูู ูู ุงูุฏูุฉ** | โ ูุง | โ ูุนู (DetailValueValidator) |
| **ุฏุนู ุงููุณุชููุงุช** | โ ูุง | โ ูุนู (4 ูุณุชููุงุช) |
| **ุงูุชูุฑูุจ** | โ ุบูุฑ ูุญุฏุฏ | โ round(, 2) |
| **ุงูุชูุงูู ูุน average_cost** | โ๏ธ ูุฏ ูููู ุฎุงุทุฆ | โ ุฏููู |

---

## ๐ก ูุซุงู ุนููู ููููุงุฑูุฉ

### ุงูุณููุงุฑูู:
ูุงุชูุฑุฉ ูุจูุนุงุช ุชุญุชูู ุนูู:
- **ุตูู 1:** ุณุนุฑ 100ุ ูููุฉ 2ุ ุฎุตู ุตูู 10
- **ุตูู 2:** ุณุนุฑ 200ุ ูููุฉ 1ุ ุฎุตู ุตูู 20
- **ุฎุตู ูุงุชูุฑุฉ:** 50 (10%)
- **ุฅุถุงูุฉ ูุงุชูุฑุฉ:** 30 (6%)
- **VAT:** 14% ุนูู ูุณุชูู ุงููุงุชูุฑุฉ

### ุงูููุฏ ุงููุฏูู:

```php
// ุตูู 1
$detail_value_1 = (100 * 2) - 10 = 190

// ุตูู 2
$detail_value_2 = (200 * 1) - 20 = 180

// ุงููุฌููุน
$total = 190 + 180 = 370

// ุงููุดููุฉ: ุฎุตู ุงููุงุชูุฑุฉ 50 ูู ููุทุจู!
// ุงููุดููุฉ: ุฅุถุงูุฉ ุงููุงุชูุฑุฉ 30 ูู ุชูุทุจู!
// ุงููุดููุฉ: VAT ูู ููุญุณุจ!
```

### ุงูููุฏ ุงูุฌุฏูุฏ:

```php
// ุญุณุงุจ invoice_subtotal ุฃููุงู
$invoiceSubtotal = (100*2 - 10) + (200*1 - 20) = 190 + 180 = 370

// ุตูู 1
$itemSubtotal_1 = 190
$distributedDiscount_1 = 50 * (190 / 370) = 25.68
$distributedAdditional_1 = 30 * (190 / 370) = 15.41
$netAfterAdjustments_1 = 190 - 25.68 + 15.41 = 179.73
$vat_1 = (370 * 0.14) * (179.73 / 370) = 25.16
$detail_value_1 = 179.73 + 25.16 = 204.89

// ุตูู 2
$itemSubtotal_2 = 180
$distributedDiscount_2 = 50 * (180 / 370) = 24.32
$distributedAdditional_2 = 30 * (180 / 370) = 14.59
$netAfterAdjustments_2 = 180 - 24.32 + 14.59 = 170.27
$vat_2 = (370 * 0.14) * (170.27 / 370) = 23.84
$detail_value_2 = 170.27 + 23.84 = 194.11

// ุงููุฌููุน
$total = 204.89 + 194.11 = 399.00

// ุงูุชุญูู: 370 - 50 + 30 + (370 * 0.14) = 399.00 โ
```

---

## ๐ ุงูุชูุฒูุน ุงููุณุจู (Proportional Distribution)

### ุงูุตูุบุฉ:

```php
// ุชูุฒูุน ุฎุตู ุงููุงุชูุฑุฉ
distributed_discount = fat_disc ร (item_subtotal / invoice_subtotal)

// ุชูุฒูุน ุฅุถุงูุฉ ุงููุงุชูุฑุฉ
distributed_additional = fat_plus ร (item_subtotal / invoice_subtotal)

// ุชูุฒูุน VAT
invoice_level_vat = vat_value ร (net_after_adjustments / invoice_subtotal)

// ุชูุฒูุน Withholding Tax
invoice_level_withholding_tax = withholding_tax_value ร (net_after_adjustments / invoice_subtotal)
```

### ูุซุงู:

```
ูุงุชูุฑุฉ:
- ุฅุฌูุงูู ุงููุงุชูุฑุฉ: 1000
- ุฎุตู ุงููุงุชูุฑุฉ: 100
- ุตูู ุจูููุฉ 300

ูุตูุจ ุงูุตูู ูู ุงูุฎุตู:
= 100 ร (300 / 1000)
= 100 ร 0.3
= 30
```

---

## โ ุงููููุฒุงุช ุงูุฌุฏูุฏุฉ

### 1. **ูุธุงู ุงููุณุชููุงุช (Levels)**

- **`invoice_level`**: ุงูุฎุตู/ุงูุฅุถุงูุฉ/ุงูุถุฑุงุฆุจ ุนูู ูุณุชูู ุงููุงุชูุฑุฉ ููุท
- **`item_level`**: ุงูุฎุตู/ุงูุฅุถุงูุฉ/ุงูุถุฑุงุฆุจ ุนูู ูุณุชูู ุงูุตูู ููุท
- **`both`**: ุฏุนู ููุง ุงููุณุชูููู ูุนุงู
- **`disabled`**: ุชุนุทูู ุงูููุฒุฉ

### 2. **ุงูุชุญูู ูู ุงูุฏูุฉ**

```php
// DetailValueValidator ูุชุญูู ูู:
- ุนุฏู ูุฌูุฏ ููู ุณุงูุจุฉ
- ุฏูุฉ ุงูุญุณุงุจุงุช (ูุงูุด ุฎุทุฃ 0.01)
- ุชุทุงุจู ุฅุฌูุงูู ุงูุฃุตูุงู ูุน ุฅุฌูุงูู ุงููุงุชูุฑุฉ
- ุตุญุฉ ุงููุณุชููุงุช
```

### 3. **ุงูุชูุฑูุจ ุงูููุญุฏ**

```php
// ุฌููุน ุงูุฃุฑูุงู ุชููุฑุจ ุฅูู ููุฒูุชูู ุนุดุฑูุชูู
round($value, 2)
```

### 4. **ุงูุชูุงูู ูุน average_cost**

```php
// detail_value ููุณุชุฎุฏู ูู ุญุณุงุจ average_cost
average_cost = SUM(detail_value) / SUM(qty_in - qty_out)
```

---

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

### ูุง ุชู ุฅุถุงูุชู:

1. โ **DetailValueCalculator Service** - ุฎุฏูุฉ ูุชุฎุตุตุฉ ููุญุณุงุจ
2. โ **DetailValueValidator Service** - ุฎุฏูุฉ ููุชุญูู ูู ุงูุฏูุฉ
3. โ **ุฏุนู ุงููุณุชููุงุช** - item_level, invoice_level, both, disabled
4. โ **ุงูุชูุฒูุน ุงููุณุจู** - ุชูุฒูุน ุงูุฎุตููุงุช ูุงูุฅุถุงูุงุช ูุงูุถุฑุงุฆุจ
5. โ **ุฏุนู ุงูุถุฑุงุฆุจ** - VAT ู Withholding Tax ุนูู ูุณุชููุงุช ูุชุนุฏุฏุฉ
6. โ **ุงูุชุญูู ูู ุงูุฏูุฉ** - ูุญุต ุชููุงุฆู ูุถูุงู ุตุญุฉ ุงูุญุณุงุจุงุช
7. โ **ุงูุชูุฑูุจ ุงูููุญุฏ** - round(, 2) ูุฌููุน ุงูุฃุฑูุงู

### ูุง ุชู ุฅุตูุงุญู:

1. โ **ูุดููุฉ ุฎุตู ุงููุงุชูุฑุฉ** - ุงูุขู ููุทุจู ุจุดูู ุตุญูุญ
2. โ **ูุดููุฉ ุฅุถุงูุฉ ุงููุงุชูุฑุฉ** - ุงูุขู ุชูุทุจู ุจุดูู ุตุญูุญ
3. โ **ูุดููุฉ ุญุณุงุจ average_cost** - ุงูุขู ุฏููู 100%
4. โ **ูุดููุฉ ุงูุถุฑุงุฆุจ** - ุงูุขู ูุฏุนููุฉ ุจุดูู ูุงูู

---

## ๐ฏ ุงูุฎูุงุตุฉ

| ุงูุฌุงูุจ | ุงูููุฏ ุงููุฏูู | ุงูููุฏ ุงูุฌุฏูุฏ |
|--------|-------------|-------------|
| **ุงูุจุณุงุทุฉ** | โ ุจุณูุท ุฌุฏุงู | โ๏ธ ูุนูุฏ (ููู ุฏููู) |
| **ุงูุฏูุฉ** | โ ุบูุฑ ุฏููู | โ ุฏููู 100% |
| **ุงููุฑููุฉ** | โ ูุญุฏูุฏ | โ ูุฑู ุฌุฏุงู |
| **ุงูุชุญูู** | โ ูุง ููุฌุฏ | โ ุดุงูู |
| **ุงูุชูุงูู** | โ๏ธ ูุฏ ูุณุจุจ ูุดุงูู | โ ูุชูุงูู ุชูุงูุงู |

**ุงูุชูุตูุฉ:** ุงุณุชุฎุฏุงู ุงูููุฏ ุงูุฌุฏูุฏ ุฏุงุฆูุงู ูุถูุงู ุฏูุฉ ุงูุญุณุงุจุงุช ูุงูุชูุงูู ูุน `average_cost`.

---

**ุขุฎุฑ ุชุญุฏูุซ:** ุฏูุณูุจุฑ 2024  
**ุงูุฅุตุฏุงุฑ:** 2.1.0
